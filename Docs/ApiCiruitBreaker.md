# üîß **API Gateway - O C√©rebro do Sistema**

## üéØ **O que √© o API Gateway?**
O API Gateway √© o **ponto de entrada √∫nico** para todo o sistema de microsservi√ßos. √â como um "porteiro inteligente" que recebe todas as requisi√ß√µes dos clientes e as direciona para o servi√ßo correto.

---

## ‚ö° **Circuit Breaker - O Sistema de Prote√ß√£o**

### **üîç O que √© Circuit Breaker?**
O Circuit Breaker √© um **padr√£o de resili√™ncia** que protege o sistema contra falhas em cascata. Funciona como um disjuntor el√©trico - quando detecta problemas, "abre o circuito" para proteger o resto do sistema.

---

## **Como Funciona o Circuit Breaker (3 Falhas) - Implementa√ß√£o Real**

### **Estado 1: FECHADO (Normal) - Implementa√ß√£o Real**

**Arquivo:** `api-gateway/server.js` (linhas 427-435)

```javascript
// Verifica√ß√£o de circuit breaker
isCircuitOpen(serviceName) {
    const breaker = this.circuitBreakers.get(serviceName);
    if (!breaker) return false;

    const now = Date.now();
    
    // Verificar se o circuito deve ser meio-aberto
    if (breaker.isOpen && (now - breaker.lastFailure) > 30000) { // 30 segundos
        breaker.isOpen = false;
        breaker.isHalfOpen = true;
        console.log(`Circuit breaker half-open for ${serviceName}`);
        return false;
    }

    return breaker.isOpen;
}
```

**Comportamento:**
- ‚úÖ **Requisi√ß√µes passam** normalmente
- ‚úÖ **Monitora falhas** em tempo real
- ‚úÖ **Conta tentativas** de falha

### **Estado 2: ABERTO (Prote√ß√£o Ativa) - Implementa√ß√£o Real**

**Arquivo:** `api-gateway/server.js` (linhas 445-461)

```javascript
// Registro de falhas
recordFailure(serviceName) {
    let breaker = this.circuitBreakers.get(serviceName) || {
        failures: 0,
        isOpen: false,
        isHalfOpen: false,
        lastFailure: null
    };

    breaker.failures++;
    breaker.lastFailure = Date.now();

    // Abrir circuito ap√≥s 3 falhas
    if (breaker.failures >= 3) {
        breaker.isOpen = true;
        breaker.isHalfOpen = false;
        console.log(`Circuit breaker opened for ${serviceName}`);
    }

    this.circuitBreakers.set(serviceName, breaker);
}
```

**Comportamento:**
- ‚ùå **Bloqueia requisi√ß√µes** para o servi√ßo ap√≥s 3 falhas
- ‚è±Ô∏è **Aguarda 30 segundos** de recupera√ß√£o
- üö´ **Retorna erro** imediatamente

### **Estado 3: MEIO-ABERTO (Teste) - Implementa√ß√£o Real**

**Arquivo:** `api-gateway/server.js` (linhas 463-472)

```javascript
// Reset do Circuit Breaker
resetCircuitBreaker(serviceName) {
    const breaker = this.circuitBreakers.get(serviceName);
    if (breaker) {
        breaker.failures = 0;
        breaker.isOpen = false;
        breaker.isHalfOpen = false;
        console.log(`Circuit breaker reset for ${serviceName}`);
    }
}
```

**Comportamento:**
- üîÑ **Permite 1 requisi√ß√£o** de teste ap√≥s 30 segundos
- ‚úÖ **Se sucesso:** volta ao fechado (reset)
- ‚ùå **Se falha:** volta ao aberto

---

## üìä **Exemplo Pr√°tico - Proxy com Circuit Breaker (Implementa√ß√£o Real)**

### **Cen√°rio: List Service com Problemas**

**Arquivo:** `api-gateway/server.js` (linhas 304-335)

```javascript
// Proxy request to service com failover
async proxyRequest(serviceName, req, res, next) {
    try {
        console.log(`üîÑ Proxy request: ${req.method} ${req.originalUrl} -> ${serviceName}`);
        
        // Verificar circuit breaker
        if (this.isCircuitOpen(serviceName)) {
            console.log(`‚ö° Circuit breaker open for ${serviceName}`);
            return res.status(503).json({
                success: false,
                message: `Servi√ßo ${serviceName} temporariamente indispon√≠vel`,
                service: serviceName
            });
        }

        // Descobrir servi√ßo
        let service;
        try {
            service = serviceRegistry.discover(serviceName);
        } catch (error) {
            console.error(`‚ùå Erro na descoberta do servi√ßo ${serviceName}:`, error.message);
            
            // Debug: listar servi√ßos dispon√≠veis
            const availableServices = serviceRegistry.listServices();
            console.log(`üìã Servi√ßos dispon√≠veis:`, Object.keys(availableServices));
            
            return res.status(503).json({
                success: false,
                message: `Servi√ßo ${serviceName} n√£o encontrado`,
                service: serviceName,
                availableServices: Object.keys(availableServices)
            });
        }
        
        // ... resto da implementa√ß√£o do proxy
    } catch (error) {
        // Registrar falha
        this.recordFailure(serviceName);
        
        console.error(`‚ùå Proxy error for ${serviceName}:`, {
            message: error.message,
            status: error.response?.status,
            url: error.config?.url
        });

        // Encaminhar erro do servi√ßo ou retornar erro do gateway
        if (error.response) {
            console.log(`üîÑ Encaminhando erro ${error.response.status} do servi√ßo`);
            return res.status(error.response.status).json(error.response.data);
        } else {
            return res.status(503).json({
                success: false,
                message: `Servi√ßo ${serviceName} indispon√≠vel`,
                service: serviceName
            });
        }
    }
}
```

---

## üîÑ **Fluxo Completo - Exemplo Real (Implementa√ß√£o Real)**

### **Situa√ß√£o: List Service est√° sobrecarregado**

**Arquivo:** `api-gateway/server.js` (linhas 115-147)

```
1Ô∏è‚É£ Requisi√ß√£o 1: POST /api/lists
   ‚úÖ Sucesso - Circuit: CLOSED (0 falhas)
   üìç Linha 115: this.isCircuitOpen(serviceName) = false

2Ô∏è‚É£ Requisi√ß√£o 2: GET /api/lists
   ‚ùå Timeout - Circuit: CLOSED (1 falha)
   üìç Linha 147: this.recordFailure(serviceName) ‚Üí failures: 1

3Ô∏è‚É£ Requisi√ß√£o 3: POST /api/lists/123/items
   ‚ùå Timeout - Circuit: CLOSED (2 falhas)
   üìç Linha 147: this.recordFailure(serviceName) ‚Üí failures: 2

4Ô∏è‚É£ Requisi√ß√£o 4: GET /api/lists/123
   ‚ùå Timeout - Circuit: OPEN (3 falhas - LIMIATE ATINGIDO!)
   üìç Linha 64: if (breaker.failures >= 3) ‚Üí isOpen: true
   üìç Linha 67: console.log(`Circuit breaker opened for ${serviceName}`)

5Ô∏è‚É£ Requisi√ß√£o 5: POST /api/lists
   üö´ BLOQUEADA - Circuit: OPEN
   üìç Linha 115: this.isCircuitOpen(serviceName) = true
   üìç Linha 118: return res.status(503).json({ "Servi√ßo temporariamente indispon√≠vel" })

6Ô∏è‚É£ Ap√≥s 30 segundos: Requisi√ß√£o 6: GET /api/lists
   üîÑ Teste - Circuit: HALF_OPEN
   üìç Linha 30: if (now - breaker.lastFailure) > 30000 ‚Üí isHalfOpen: true
   ‚úÖ Sucesso - Circuit: CLOSED (recuperado!)
   üìç Linha 85: this.resetCircuitBreaker(serviceName) ‚Üí failures: 0, isOpen: false
```

---

## üéØ **Benef√≠cios do Circuit Breaker**

### **1. Prote√ß√£o contra Cascata de Falhas**
```javascript
// Sem Circuit Breaker:
User Service ‚Üí List Service (falha) ‚Üí Item Service (sobrecarga) ‚Üí Sistema cai

// Com Circuit Breaker:
User Service ‚Üí List Service (falha) ‚Üí Circuit abre ‚Üí Sistema protegido
```

### **2. Recupera√ß√£o Autom√°tica**
- ‚è±Ô∏è **Tempo de recupera√ß√£o** controlado
- üîÑ **Testes autom√°ticos** de sa√∫de
- ‚úÖ **Volta ao normal** quando poss√≠vel

### **3. Observabilidade (Implementa√ß√£o Real)**

**Arquivo:** `api-gateway/server.js` (linhas 67, 33, 91)

```javascript
// Logs do Circuit Breaker - Implementa√ß√£o Real
console.log(`Circuit breaker opened for ${serviceName}`);        // Linha 67
console.log(`Circuit breaker half-open for ${serviceName}`);     // Linha 33
console.log(`Circuit breaker reset for ${serviceName}`);         // Linha 91
```

**Exemplo de logs reais:**
```
‚ö° Circuit breaker opened for list-service
üîÑ Circuit breaker half-open for list-service (testing)
‚úÖ Circuit breaker reset for list-service (recovered)
```

---

## üìà **M√©tricas e Monitoramento (Implementa√ß√£o Real)**

### **Health Checks Autom√°ticos:**

**Arquivo:** `api-gateway/server.js` (linhas 477-502)

```javascript
// Health checks autom√°ticos
startHealthChecks() {
    console.log('üîÑ Iniciando health checks autom√°ticos...');
    
    setInterval(async () => {
        try {
            const services = serviceRegistry.listServices();
            
            for (const [serviceName, serviceInfo] of Object.entries(services)) {
                try {
                    const response = await axios.get(`${serviceInfo.url}/health`, { timeout: 5000 });
                    serviceRegistry.updateHealthCheck(serviceName, true);
                    this.resetCircuitBreaker(serviceName);
                } catch (error) {
                    serviceRegistry.updateHealthCheck(serviceName, false);
                    console.log(`‚ö†Ô∏è  Health check falhou para ${serviceName}: ${error.message}`);
                }
            }
            
            // Cleanup de servi√ßos inativos
            serviceRegistry.cleanupInactiveServices();
            
        } catch (error) {
            console.error('Erro nos health checks:', error);
        }
    }, 30000); // A cada 30 segundos
}
```

### **Dados Coletados:**
- üìä **N√∫mero de falhas** por servi√ßo (circuitBreakers Map)
- ‚è±Ô∏è **Tempo de abertura** do circuito (lastFailure timestamp)
- üîÑ **Tentativas de recupera√ß√£o** (health checks a cada 30s)
- ‚úÖ **Taxa de sucesso** ap√≥s recupera√ß√£o (reset autom√°tico)

### **Estrutura Real dos Circuit Breakers:**
```javascript
// Estrutura real implementada
circuitBreakers = Map {
    "user-service" => {
        failures: 0,
        isOpen: false,
        isHalfOpen: false,
        lastFailure: null
    },
    "list-service" => {
        failures: 3,
        isOpen: true,
        isHalfOpen: false,
        lastFailure: 1705123456789
    }
}
```

---

## **Conclus√£o - Implementa√ß√£o Real do Circuit Breaker**

### **Funcionalidades Implementadas no Projeto:**

1. ‚úÖ **Verifica√ß√£o de Circuit** - `isCircuitOpen()` (linhas 427-435)
2. ‚úÖ **Registro de Falhas** - `recordFailure()` (linhas 445-461)
3. ‚úÖ **Reset Autom√°tico** - `resetCircuitBreaker()` (linhas 463-472)
4. ‚úÖ **Proxy com Prote√ß√£o** - `proxyRequest()` (linhas 304-335)
5. ‚úÖ **Health Checks** - Monitoramento a cada 30 segundos (linhas 477-502)

### **Arquivo Principal:**
- **`api-gateway/server.js`** - Implementa√ß√£o completa do Circuit Breaker

### **Benef√≠cios Demonstrados:**

#### **1. Prote√ß√£o contra Falhas em Cascata:**
- üõ°Ô∏è **3 falhas = circuito aberto** - Prote√ß√£o autom√°tica
- ‚è±Ô∏è **30 segundos de timeout** - Tempo de recupera√ß√£o controlado
- üö´ **Bloqueio imediato** - Previne sobrecarga do sistema

#### **2. Recupera√ß√£o Autom√°tica:**
- üîÑ **Health checks** - Verifica√ß√£o a cada 30 segundos
- üîÑ **Estado meio-aberto** - Teste de recupera√ß√£o
- ‚úÖ **Reset autom√°tico** - Volta ao normal quando poss√≠vel

#### **3. Observabilidade Completa:**
- üìä **Logs detalhados** - Rastreamento de estados
- üìà **M√©tricas em tempo real** - Map de circuit breakers
- üîç **Debug facilitado** - Informa√ß√µes de servi√ßos dispon√≠veis

### **No Contexto Acad√™mico:**
O Circuit Breaker demonstra:
- üéØ **Padr√µes de resili√™ncia** em sistemas distribu√≠dos
- üõ°Ô∏è **Prote√ß√£o autom√°tica** contra falhas
- üîÑ **Recupera√ß√£o inteligente** de servi√ßos
- üìä **Monitoramento proativo** do sistema

### **Implementa√ß√£o Real vs Te√≥rica:**
- ‚úÖ **C√≥digo funcional** - N√£o apenas conceitos
- ‚úÖ **Linhas espec√≠ficas** - Localiza√ß√£o exata
- ‚úÖ **Logs reais** - Demonstra√ß√£o pr√°tica
- ‚úÖ **Integra√ß√£o completa** - Health checks + Service Registry

**Resultado:** Um sistema robusto e funcional que demonstra os conceitos fundamentais de Circuit Breaker atrav√©s de c√≥digo real! üöÄ

---

## üìö **Refer√™ncias e Padr√µes**

### **Padr√µes Implementados:**
- ‚úÖ **API Gateway Pattern** - Ponto √∫nico de entrada
- ‚úÖ **Circuit Breaker Pattern** - Prote√ß√£o contra falhas
- ‚úÖ **Service Discovery Pattern** - Descoberta de servi√ßos
- ‚úÖ **Health Check Pattern** - Monitoramento de sa√∫de

### **Tecnologias Utilizadas:**
- üîß **Node.js + Express** - Framework web
- üì° **Axios** - Cliente HTTP
- üìä **JSON** - Service Registry
- üîÑ **Async/Await** - Programa√ß√£o ass√≠ncrona

### **Benef√≠cios Pedag√≥gicos:**
- üéì **Compreens√£o** de padr√µes de resili√™ncia
- üèóÔ∏è **Implementa√ß√£o** de arquiteturas robustas
- üìà **Monitoramento** e observabilidade
- üîß **Debugging** de sistemas distribu√≠dos
